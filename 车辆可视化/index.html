<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>实时车辆监控系统</title>
    <link rel="icon" href="data:,">  <!-- 添加空favicon声明 -->
    <style>
        #container {
            width: 100%;
            height: 100vh;
        }
        .car-marker {
            width: 32px;
            height: 32px;
            background-size: cover;
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=69029a874e543988e8efa6adfee0111d"></script>
    <script>
        // 初始化地图
        const map = new AMap.Map('container', {
            zoom: 12,
            center: [116.397428, 39.90923]  // 北京市中心坐标
        });

        // 车辆数据模拟器
        let markers = [];
        function generateVehicleData() {
            return Array.from({length: 20}, (_, i) => ({
                id: `京A${Math.random().toString().substr(2,6)}`,
                position: [
                    116.39 + (Math.random() - 0.5) * 0.2,  // 经度波动范围
                    39.90 + (Math.random() - 0.5) * 0.15  // 纬度波动范围
                ],
                status: Math.random() > 0.1 ? 'online' : 'offline'  // 10%离线率
            }));
        }

        // 创建车辆标记
        function updateVehicles(vehicles) {
            // 清除旧标记
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            vehicles.forEach(vehicle => {
                // 自定义SVG图标
                // 优化后的无箭头图标
                const iconSVG = `<svg width="40" height="40" viewBox="0 0 40 40" 
                    style="transform: rotate(${vehicle.direction || 0}deg);transform-origin: 20px 20px;">
                    <circle cx="20" cy="20" r="16" fill="${vehicle.status === 'online' ? '#2ecc71' : '#e74c3c'}" 
                        stroke="#fff" stroke-width="2" class="pulse"/>
                    <circle cx="20" cy="20" r="4" fill="#fff"/>
                </svg>`;

                const marker = new AMap.Marker({
                    position: vehicle.position,
                    content: iconSVG,
                    offset: new AMap.Pixel(-20, -40),
                    extData: vehicle // 绑定完整数据
                });

                // 增强信息窗口
                const infoWindow = new AMap.InfoWindow({
                    content: `<div class="info-window">
                        <h3>${vehicle.id}</h3>
                        <div class="status ${vehicle.status}">
                            ${vehicle.status === 'online' ? '运营中' : '已离线'}
                        </div>
                        <table>
                            <tr><td>实时速度：</td><td>${vehicle.speed || 0} km/h</td></tr>
                            <tr><td>方向：</td><td>${vehicle.direction || 0}°</td></tr>
                            <tr><td>最后上报：</td><td>${new Date().toLocaleTimeString()}</td></tr>
                        </table>
                    </div>`,
                    offset: new AMap.Pixel(0, -40)
                });

                // 交互增强
                marker.on('mouseover', () => marker.setContent(iconSVG.replace('40', '48')));
                marker.on('mouseout', () => marker.setContent(iconSVG));
                marker.on('click', () => {
                    infoWindow.open(map, marker.getPosition());
                    map.setZoomAndCenter(16, marker.getPosition());
                });
                marker.on('click', () => infoWindow.open(map, marker.getPosition()));
                markers.push(marker);
            });

            map.add(markers);
        }

        // 车辆数据获取（替换原来的模拟数据）
        async function fetchVehicleData() {
            try {
                const response = await fetch('data/gps_data.json');
                const data = await response.json();
                return data.vehicles.map(v => ({
                    id: v.vehicle_id,
                    position: [parseFloat(v.longitude), parseFloat(v.latitude)],
                    status: v.status
                }));
            } catch (error) {
                console.error('数据加载失败:', error);
                return [];
            }
        }

        // 定时更新数据
        setInterval(async () => {
            const vehicles = await fetchVehicleData();
            updateVehicles(vehicles);
        }, 3000);

        // 初始加载
        fetchVehicleData().then(vehicles => updateVehicles(vehicles));
    </script>
</body>
</html>